<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="stylesheet" href="/docs/assets/css/main.css" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
    (function(canonical) {
      if (!document.location.href.substr(0, document.location.href.length - document.location.hash.length).startsWith(canonical)) {
        window.location.replace(canonical);
      }
    })('https://www.thethingsnetwork.org/docs/gateways/kerlink/station/firmware-updates.html');
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Firmware Updates | The Things Network</title>
<meta name="generator" content="Jekyll v3.4.5" />
<meta property="og:title" content="Firmware Updates" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Kerlink Wirnet Station Firmware Updates" />
<meta property="og:description" content="Kerlink Wirnet Station Firmware Updates" />
<link rel="canonical" href="https://www.thethingsnetwork.org/docs/gateways/kerlink/station/firmware-updates.html" />
<meta property="og:url" content="https://www.thethingsnetwork.org/docs/gateways/kerlink/station/firmware-updates.html" />
<meta property="og:site_name" content="The Things Network" />
<meta property="og:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-10T16:58:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="twitter:title" content="Firmware Updates" />
<meta name="twitter:site" content="@thethingsnetwrk" />
<meta property="article:publisher" content="https://www.facebook.com/thethingsnetwork" />
<script type="application/ld+json">
{"datePublished":"2021-03-10T16:58:00+00:00","image":"https://www.thethingsnetwork.org/docs/assets/images/og-image.png","description":"Kerlink Wirnet Station Firmware Updates","url":"https://www.thethingsnetwork.org/docs/gateways/kerlink/station/firmware-updates.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ttnstaticfile.blob.core.windows.net/static/common/favicon/largetile.png"}},"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.thethingsnetwork.org/docs/gateways/kerlink/station/firmware-updates.html"},"headline":"Firmware Updates","dateModified":"2021-03-10T16:58:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
    <link rel="apple-touch-icon-precomposed" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png">
    <meta name="application-name" content="The Things Network">
    <meta name="msapplication-tooltip" content="Tooltip">
    <meta name="msapplication-config" content="https://ttnweb.azureedge.net/static/common/favicon/ieconfig.54334a5ee30c.xml">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-32.61b30f85680a.png" sizes="32x32">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-57.83b86c64dc82.png" sizes="57x57">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-76.7dcf8fa36dfc.png" sizes="76x76">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-96.27ac17adaa8b.png" sizes="96x96">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-120.e1526731335e.png" sizes="120x120">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-128.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png" sizes="144x144">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png" sizes="152x152">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-180.fcd414307ca3.png" sizes="180x180">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-195.c55ce09d66da.png" sizes="195x195">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-228.bea53ec4b10b.png" sizes="228x228">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/smalltile.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/mediumtile.3d42f7faac82.png" sizes="270x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/widetile.3d42f7faac82.png" sizes="558x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/largetile.eb144ebab4d1.png" sizes="558x558">
    <link rel="shortcut icon" sizes="196x196" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-196.277278d69ddc.png">
    <script src="/docs/assets/js/main.js"></script>
  </head>
  <body>
    <div id="header"></div>
    <div id="content">
<div class="layout-page">
  <!-- <div class="ttn-header ttn-header-small">
    <div class="ttn-container container-fluid">
      <h1>
        <img src="/docs/assets/images/the-things-white.png" alt="⛅ The Things Network" />
        <span>Learn</span>
      </h1>
    </div>
  </div> -->
  <div class="container-fluid ttn-container">
    <div class="row page-top-nav">
      <div class="col-sm-9">
        <ul>
          <li class="page-top-nav-crumb"><a href="http://www.thethingsnetwork.org/">Home</a></li>
          <li class="page-top-nav-crumb"><a href="/docs/">Learn</a></li>
                <li class=""><a href="/docs/lorawan/">LoRaWAN</a></li>
                <li class=""><a href="/docs/devices/">Devices</a></li>
                <li class="active"><a href="/docs/gateways/">Gateways</a></li>
                <li class=""><a href="/docs/network/">Network</a></li>
                <li class=""><a href="/docs/applications/">Applications</a></li>
                <li class=""><a href="/docs/the-things-stack-v3/">The Things Stack V3</a></li>
        </ul>
      </div>
      <div class="hidden-xs col-sm-3 text-right">
        <a href="https://github.com/TheThingsNetwork/docs/edit/master/_content/gateways/kerlink/station/firmware-updates.md" class="page-edit" data-proofer-ignore><i class="fa fa-github"></i> Edit <strong>firmware-updates.md</strong></a>
      </div>
      <div class="col-12">
        This documentation page applies to the legacy Things Network Stack V2. Documentation for The Things Stack V3 is available <a href="https://thethingsstack.io">here</a>
      </div>
    </div>
    <div class="row wrapper">
      <div class="col-sm-3 side-nav">
        <div class="panel page-side-nav">
          <div class="panel-body">
            <ul>
              <li class=""><a href="/docs/gateways/index.html"><h5>Gateways</h5></a>
            <ul>
                <li class=""><a href="/docs/gateways/basics-station/">LoRa Basics™ Station</a>
                </li>
                <li class=""><a href="/docs/gateways/certificates/">Root Certificates</a>
                </li>
            </ul>
              </li>
            <li class="page-side-nav-section"><span>Running a gateway</span>
            <ul>
                <li class=""><a href="/docs/gateways/start/">Where to start</a>
                </li>
                <li class=""><a href="/docs/gateways/registration.html">Gateway Registration</a>
                </li>
                <li class=""><a href="/docs/gateways/packet-forwarder/">Packet Forwarders</a>
                </li>
                <li class=""><a href="/docs/gateways/lightning-protection.html">Lightning Protection</a>
                </li>
                <li class=""><a href="/docs/gateways/troubleshooting/">Troubleshooting</a>
                </li>
            </ul>
            </li>
            <li class="page-side-nav-section"><span>Hardware</span>
            <ul>
                <li class=""><a href="/docs/gateways/thethingsindoor/">The Things Indoor Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/thethingsoutdoor/">The Things Outdoor Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/gateway/">The Things Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/multitech/">MultiTech Conduit</a>
                </li>
                <li class=""><a href="/docs/gateways/rak2245/">RAK2245 Pi Hat Edition - LoRaWAN® Gateway Concentrator Module</a>
                </li>
                <li class=""><a href="/docs/gateways/rak7243c/">RAK7243C Pilot Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/rak831/">RAK831</a>
                </li>
                <li class=""><a href="/docs/gateways/pisupply-hat/">Pi Supply Gateway HAT</a>
                </li>
                <li class=""><a href="/docs/gateways/aaeon/">AAEON</a>
                </li>
                <li class=""><a href="/docs/gateways/cisco/">Cisco LoRaWAN Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/">Kerlink</a>
            <ul>
                <li class=""><a href="/docs/gateways/kerlink/keros/">KerOS installation and configuration</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/station/">Wirnet Station</a>
            <ul>
                <li class=""><a href="/docs/gateways/kerlink/station/specs.html">Specifications</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/station/setup.html">Setup</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/station/config.html">Configuration</a>
                </li>
                <li class="active"><a href="/docs/gateways/kerlink/station/firmware-updates.html">Firmware Updates</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/station/cellular.html">Cellular Connection</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/station/mount.html">Mount</a>
                </li>
            </ul>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/ibts/">Wirnet iBTS</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/ifemtocell/">Wirnet iFemtoCell</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/ifemtocell-evolution/">Wirnet iFemtoCell Evolution</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/istation/">Wirnet iStation</a>
                </li>
            </ul>
                </li>
                <li class=""><a href="/docs/gateways/laird/">Laird RG1xx</a>
                </li>
                <li class=""><a href="/docs/gateways/lorrier/">Lorrier LR2</a>
                </li>
                <li class=""><a href="/docs/gateways/mikrotik/">MikroTik Routerboard</a>
                </li>
                <li class=""><a href="/docs/gateways/st/">P-NUCLEO-LRWAN2</a>
                </li>
                <li class=""><a href="/docs/gateways/tektelic/">Tektelic</a>
                </li>
                <li class=""><a href="/docs/gateways/ursalink/">Ursalink</a>
                </li>
            </ul>
            </li>
            </ul>
            <!-- <li class="hidden-xs col-sm-2 page-toc page-affix"></li> --> 
          </div>
        </div> 
      </div>
      <div class="col-sm-9 page-body">
        <div class="panel">
          <div class="panel-body page-content">
            <h1 id="kerlink-wirnet-station-firmware-updates">Kerlink Wirnet Station Firmware Updates</h1>
<p>Please read through this entire document before performing the firmware update. If the procedure is not done correctly you stand a chance to brick your gateway. A firmware upgrade will most likely result in a factory reset of the gateway.</p>
<h2 id="firmware-update-procedure-summary">Firmware update procedure summary</h2>
<ul>
  <li>Format a USB flash drive as FAT32.</li>
  <li>Download produsb_wirnet_v3.6.zip from <a href="https://raw.githubusercontent.com/TheThingsNetwork/kerlink-station-firmware/master/dota/produsb_wirnet_v3.6.zip">here</a>.</li>
  <li>Extract produsb_wirnet_v3.6.zip to the flash drive so that the produsb.sh and produsb_wirnet_v3.6.md5 files are the only two files on the flash drive.</li>
  <li>Download usbflashdrive_wirmav2_wirnet_v3.6.zip from <a href="https://raw.githubusercontent.com/TheThingsNetwork/kerlink-station-firmware/master/dota/usbflashdrive_wirmav2_wirnet_v3.6.zip">here</a>.</li>
  <li>Extract usbflashdrive_wirmav2_wirnet_v3.6.zip to the root of the flash drive so that the content of this zip file is extracted to the same level as where produsb.sh is located.</li>
  <li>Safely remove the flash drive from your computer.</li>
  <li>Your Kerlink gateway should already be switched on and booted up. The safest is to power up the gateway and to wait two minutes for it to fully boot up.</li>
  <li>Plug the flash drive into the USB port on the Kerlink. If the flash drive has a light it will start blinking. The gateway will detect the firmware file on the flash drive and start installing it. If you press the Test button on the gateway you will see the MOD1 and MOD2 lights flashing. When they stop flashing the firmware update is completeted and you can remove the flash drive from the USB port.</li>
</ul>
<h2 id="about-the-firmware">About the firmware</h2>
<p>Kerlink Wirnet Station firmware updates are installed from a USB drive. This needs to be a USB 1.1 compatible device formatted as FAT32.
The firmware consists of two parts:</p>
<ul>
  <li><strong>System Firmware</strong> (usually) from Kerlink
    <ul>
      <li>Installed in <code class="highlighter-rouge">/</code> partition</li>
    </ul>
  </li>
  <li><strong>User Firmware</strong> from TTN/TTI/Partner
    <ul>
      <li>Installed in <code class="highlighter-rouge">/mnt/fsuser-1</code> partition</li>
      <li>Includes “global” configuration</li>
    </ul>
  </li>
</ul>
<p>The update process is simple:</p>
<ul>
  <li>Plug in the USB drive</li>
  <li>Wait for 5 minutes</li>
  <li>A log file is written back to USB drive (<code class="highlighter-rouge">produsb.log</code>)</li>
</ul>
<h2 id="system-firmware-v31-and-above">System Firmware (v3.1 and above)</h2>
<blockquote>
  <p>⚠️ WARNING: After installation of this firmware you will not be able to revert to v2.3.3 - an attempt will brick your gateway. Refer Kerlink Wiki.</p>
</blockquote>
<p>The Gateway is shipped with Kerlink’s “stock system firmware”. A backup of this system firmware is kept for recovery purposes (on the rescue FS). The system firmware can be updated by putting the contents of <code class="highlighter-rouge">usbflashdrive_wirmav2_wirnet_v3.1.zip</code> on a USB drive. Firmware updates do not overwrite the backup, rescue FS can be updated with <code class="highlighter-rouge">fs_rescue</code> files (see Kerlink wiki).</p>
<p>Contents of USB drive:</p>
<ul>
  <li><code class="highlighter-rouge">u-boot.bin</code> - the bootloader binary</li>
  <li><code class="highlighter-rouge">initramfs.cpio.gz.uboot</code> - the initial RAM filesystem that handles updates and recovery</li>
  <li><code class="highlighter-rouge">script_uboot.img</code> - bootloader scripts</li>
  <li><code class="highlighter-rouge">produsb.sh</code> - this script is executed by the initramfs</li>
  <li><code class="highlighter-rouge">uImage</code> - the Linux kernel</li>
  <li><code class="highlighter-rouge">rootfs.tar.gz</code> - the root filesystem, will be extracted to <code class="highlighter-rouge">/</code> (<code class="highlighter-rouge">/dev/mtdblock5</code>)</li>
  <li><code class="highlighter-rouge">userfs.tar</code> - the user filesystem, will be extracted to <code class="highlighter-rouge">/mnt/fsuser-1</code> (<code class="highlighter-rouge">/dev/mtdblock6</code>)</li>
</ul>
<h2 id="recovery-andor-factory-reset">Recovery and/or factory reset</h2>
<p>A factory reset can be performed by doing a firmware upgrade using a USB flash drive. This will only work if the currently running firmware is working. If it does not work, try the next option.</p>
<p>The gateway automatically restores the “stock system firmware” from the rescue FS if it detects that it is unstable. The gateway is considered unstable if the u-boot <code class="highlighter-rouge">bootfail</code> variable is greater than <code class="highlighter-rouge">max_bootfail</code>. This <code class="highlighter-rouge">max_bootfail</code> is 20 by default. The <code class="highlighter-rouge">bootfail</code> variable is incremented on each boot and reset when the gateway successfully starts. Both <code class="highlighter-rouge">bootfail</code> and <code class="highlighter-rouge">max_bootfail</code> can be set with the <code class="highlighter-rouge">fw_setenv</code> tool (or with <code class="highlighter-rouge">setenv</code> and <code class="highlighter-rouge">saveenv</code> in the u-boot console). Forcing the recovery process can be done by pressing the reset button for at least <code class="highlighter-rouge">max_bootfail</code> times with intervals of 4-10 seconds. This does not overwrite the user filesystem <code class="highlighter-rouge">/mnt/fsuser-1</code> (<code class="highlighter-rouge">/dev/mtdblock6</code>).</p>
<p>If pressing the reset button multiple times does not reset the gateway, you can try using the Wirgrid device to log into the gateway’s boot loader and perform a reset from there. See <a href="https://www.thethingsnetwork.org/forum/t/convert-actility-kerlink-gateway-to-ttn/24026">this forum topic</a>.</p>
<h2 id="user-firmware-and-system-firmware-customizations">User Firmware and System Firmware Customizations</h2>
<p>The Gateway is usually shipped without or with outdated user firmware. The user firmware can be updated with <code class="highlighter-rouge">dota_XXXX.tar.gz</code> and <code class="highlighter-rouge">custo_XXXX.tar.gz</code> files.</p>
<p>Contents of USB drive:</p>
<ul>
  <li><code class="highlighter-rouge">produsb.sh</code> - the script that executes the update steps</li>
  <li><code class="highlighter-rouge">dota_XXXX.tar.gz</code> - customizes/updates the <strong>user firmware</strong>. Example contents of a <code class="highlighter-rouge">dota_thethingsnetwork_XXX.tar.gz</code> file:
    <ul>
      <li><code class="highlighter-rouge">begin_dota.sh</code> - executed at the begin of the update</li>
      <li><code class="highlighter-rouge">end_dota.sh</code> - executed at the end of the update</li>
      <li><code class="highlighter-rouge">mnt/fsuser-1/thethingsnetwork/poly_pkt_fwd.sh</code> - script that wraps the packet forwarder (sometimes called <code class="highlighter-rouge">wrapper.sh</code>)</li>
      <li><code class="highlighter-rouge">mnt/fsuser-1/thethingsnetwork/poly_pkt_fwd</code> - the packet forwarder binary</li>
      <li><code class="highlighter-rouge">mnt/fsuser-1/thethingsnetwork/global_conf.json</code> - configuration file for the packet forwarder</li>
      <li><code class="highlighter-rouge">mnt/fsuser-1/thethingsnetwork/manifest.xml</code> - description of the “package” including auto-start settings</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">custo_XXXX.tar.gz</code> customizes/updates the <strong>system firmware</strong> (<strong>and</strong> the backup). Example contents of <code class="highlighter-rouge">custo_libloragw_4.1.3-klk3_wirnet.tar.gz</code>:
    <ul>
      <li><code class="highlighter-rouge">usr/local/bin/util_fpga_start</code> - Utility to start the FPGA that handles listen-before-talk (LBT)</li>
    </ul>
  </li>
</ul>
<p>After editing the contents of the <code class="highlighter-rouge">dota_XXXX.tar.gz</code> file, compress with <code class="highlighter-rouge">tar -cvzf dota_upgrade.tar.gz --owner root --group root mnt usr</code> (use <code class="highlighter-rouge">gtar</code> on macOS).</p>
<h2 id="usb-firmware-update-security">USB Firmware update security</h2>
<ul>
  <li>Set a password in <code class="highlighter-rouge">/etc/usbkey.txt</code> on the gateway</li>
  <li>The same password must be in <code class="highlighter-rouge">usbkey.txt</code> on the USB drive</li>
</ul>
<h2 id="i-still-have-problems-or-i-am-still-unsure-about-the-firmware-update">I still have problems or I am still unsure about the firmware update</h2>
<p>Have a look on the Kerlink Wiki: http://wikikerlink.fr/lora-station</p>
<h2 id="resources">Resources</h2>
<ul>
  <li>v3.6 produsb:<br />
<a href="https://raw.githubusercontent.com/TheThingsNetwork/kerlink-station-firmware/legacy/dota/produsb_wirnet_v3.6.zip">produsb_wirnet_v3.6.zip</a></li>
  <li>v3.6 firmware: <a href="https://raw.githubusercontent.com/TheThingsNetwork/kerlink-station-firmware/legacy/dota/usbflashdrive_wirmav2_wirnet_v3.6.zip">usbflashdrive_wirmav2_wirnet_v3.6.zip</a></li>
</ul>
          </div>  
        </div>
        <div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="lightbox" tabindex="-1" role="dialog">
  <div class="modal-dialog text-center" role="document" style="width:auto;padding:20px;">
    <a href="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png"><img class="modal-content modal-body" src="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png" alt="Zoom" /></a>
  </div>
</div>
<script src="/docs/assets/js/page.js"></script>
    </div>
    <div id="footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ttn-components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-navbar.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-footer.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ga.js"></script>
  </body>
</html>
