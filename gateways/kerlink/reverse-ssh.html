<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="stylesheet" href="/docs/assets/css/main.css" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
    (function(canonical) {
      if (!document.location.href.substr(0, document.location.href.length - document.location.hash.length).startsWith(canonical)) {
        window.location.replace(canonical);
      }
    })('https://www.thethingsnetwork.org/docs/gateways/kerlink/reverse-ssh.html');
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Reverse SSH | The Things Network</title>
<meta name="generator" content="Jekyll v3.4.5" />
<meta property="og:title" content="Reverse SSH" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Reverse SSH" />
<meta property="og:description" content="Reverse SSH" />
<link rel="canonical" href="https://www.thethingsnetwork.org/docs/gateways/kerlink/reverse-ssh.html" />
<meta property="og:url" content="https://www.thethingsnetwork.org/docs/gateways/kerlink/reverse-ssh.html" />
<meta property="og:site_name" content="The Things Network" />
<meta property="og:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-23T12:55:33+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="twitter:title" content="Reverse SSH" />
<meta name="twitter:site" content="@thethingsnetwrk" />
<meta property="article:publisher" content="https://www.facebook.com/thethingsnetwork" />
<script type="application/ld+json">
{"headline":"Reverse SSH","dateModified":"2021-03-23T12:55:33+00:00","datePublished":"2021-03-23T12:55:33+00:00","description":"Reverse SSH","url":"https://www.thethingsnetwork.org/docs/gateways/kerlink/reverse-ssh.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.thethingsnetwork.org/docs/gateways/kerlink/reverse-ssh.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ttnstaticfile.blob.core.windows.net/static/common/favicon/largetile.png"}},"image":"https://www.thethingsnetwork.org/docs/assets/images/og-image.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
    <link rel="apple-touch-icon-precomposed" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png">
    <meta name="application-name" content="The Things Network">
    <meta name="msapplication-tooltip" content="Tooltip">
    <meta name="msapplication-config" content="https://ttnweb.azureedge.net/static/common/favicon/ieconfig.54334a5ee30c.xml">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-32.61b30f85680a.png" sizes="32x32">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-57.83b86c64dc82.png" sizes="57x57">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-76.7dcf8fa36dfc.png" sizes="76x76">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-96.27ac17adaa8b.png" sizes="96x96">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-120.e1526731335e.png" sizes="120x120">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-128.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png" sizes="144x144">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png" sizes="152x152">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-180.fcd414307ca3.png" sizes="180x180">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-195.c55ce09d66da.png" sizes="195x195">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-228.bea53ec4b10b.png" sizes="228x228">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/smalltile.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/mediumtile.3d42f7faac82.png" sizes="270x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/widetile.3d42f7faac82.png" sizes="558x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/largetile.eb144ebab4d1.png" sizes="558x558">
    <link rel="shortcut icon" sizes="196x196" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-196.277278d69ddc.png">
    <script src="/docs/assets/js/main.js"></script>
  </head>
  <body>
    <div id="header"></div>
    <div id="content">
<div class="layout-page">
  <!-- <div class="ttn-header ttn-header-small">
    <div class="ttn-container container-fluid">
      <h1>
        <img src="/docs/assets/images/the-things-white.png" alt="⛅ The Things Network" />
        <span>Learn</span>
      </h1>
    </div>
  </div> -->
  <div class="container-fluid ttn-container">
    <div class="row page-top-nav">
      <div class="col-sm-9">
        <ul>
          <!--<li class="page-top-nav-crumb"><a href="http://www.thethingsnetwork.org/">Home</a></li>-->
          <li class="page-top-nav-crumb"><a href="/docs/">Learn</a></li>
                <li class=""><a href="/docs/quick-start/">Quick Start</a></li>
                <li class=""><a href="/docs/lorawan/">LoRaWAN</a></li>
                <li class=""><a href="/docs/devices-and-gateways/">Devices & Gateways</a></li>
                <li class=""><a href="/docs/applications-and-integrations/">Applications</a></li>
                <li class=""><a href="/docs/the-things-stack/">The Things Stack</a></li>
                <li class=""><a href="/docs/v2-docs/">V2 docs</a></li>
        </ul>
      </div>
      <div class="hidden-xs col-sm-3 text-right">
        <a href="https://github.com/TheThingsNetwork/docs/edit/master/_content/gateways/kerlink/reverse-ssh.md" class="page-edit" data-proofer-ignore><i class="fa fa-github"></i> Edit <strong>reverse-ssh.md</strong></a>
      </div>
    </div>
    <div class="row wrapper">
      <div class="col-sm-3 side-nav">
        <div class="panel page-side-nav">
          <div class="panel-body">
            <ul>
              <li class=""><a href="/docs/gateways/index.html"><h5>Gateways</h5></a>
            <ul>
                <li class=""><a href="/docs/gateways/basics-station/">LoRa Basics™ Station</a>
                </li>
                <li class=""><a href="/docs/gateways/certificates/">Root Certificates</a>
                </li>
            </ul>
              </li>
            <li class="page-side-nav-section"><span>Running a gateway</span>
            <ul>
                <li class=""><a href="/docs/gateways/start/">Where to start</a>
                </li>
                <li class=""><a href="/docs/gateways/registration.html">Gateway Registration</a>
                </li>
                <li class=""><a href="/docs/gateways/packet-forwarder/">Packet Forwarders</a>
                </li>
                <li class=""><a href="/docs/gateways/lightning-protection.html">Lightning Protection</a>
                </li>
                <li class=""><a href="/docs/gateways/troubleshooting/">Troubleshooting</a>
                </li>
            </ul>
            </li>
            <li class="page-side-nav-section"><span>Hardware</span>
            <ul>
                <li class=""><a href="/docs/gateways/thethingsindoor/">The Things Indoor Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/thethingsoutdoor/">The Things Outdoor Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/gateway/">The Things Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/multitech/">MultiTech Conduit</a>
                </li>
                <li class=""><a href="/docs/gateways/rak2245/">RAK2245 Pi Hat Edition - LoRaWAN® Gateway Concentrator Module</a>
                </li>
                <li class=""><a href="/docs/gateways/rak7243c/">RAK7243C Pilot Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/rak831/">RAK831</a>
                </li>
                <li class=""><a href="/docs/gateways/pisupply-hat/">Pi Supply Gateway HAT</a>
                </li>
                <li class=""><a href="/docs/gateways/aaeon/">AAEON</a>
                </li>
                <li class=""><a href="/docs/gateways/cisco/">Cisco LoRaWAN Gateway</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/">Kerlink</a>
            <ul>
                <li class="active"><a href="/docs/gateways/kerlink/reverse-ssh.html">Reverse SSH</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/keros/">KerOS installation and configuration</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/station/">Wirnet Station</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/ibts/">Wirnet iBTS</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/ifemtocell/">Wirnet iFemtoCell</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/ifemtocell-evolution/">Wirnet iFemtoCell Evolution</a>
                </li>
                <li class=""><a href="/docs/gateways/kerlink/istation/">Wirnet iStation</a>
                </li>
            </ul>
                </li>
                <li class=""><a href="/docs/gateways/laird/">Laird RG1xx</a>
                </li>
                <li class=""><a href="/docs/gateways/lorrier/">Lorrier LR2</a>
                </li>
                <li class=""><a href="/docs/gateways/mikrotik/">MikroTik Routerboard</a>
                </li>
                <li class=""><a href="/docs/gateways/st/">P-NUCLEO-LRWAN2</a>
                </li>
                <li class=""><a href="/docs/gateways/tektelic/">Tektelic</a>
                </li>
                <li class=""><a href="/docs/gateways/ursalink/">Ursalink</a>
                </li>
            </ul>
            </li>
            </ul>
            <!-- <li class="hidden-xs col-sm-2 page-toc page-affix"></li> --> 
          </div>
        </div> 
      </div>
      <div class="col-sm-9 page-body">
        <div class="panel">
          <div class="panel-body page-content">
            <h1 id="reverse-ssh">Reverse SSH</h1>
<p>SSH is a secure connection between a client and server over which commands can be executed on the server. As long as the two devices can see each other on the internet the SSH connection can also be made from the server to the client. This is however often blocked by firewalls and NATs.</p>
<p>SSH also has the ability of forwarding ports over this secure connection, creating in essense a simple VPN. This can be used to dial another SSH connection from the server to the client via an existing SSH connection from the client to the server. This is called reverse SSH.</p>
<p>http://www.pc-freak.net/blog/reverse-ssh-tunnel/</p>
<h2 id="setup-your-ssh-server">Setup your SSH server</h2>
<p>You will need a server or other computer running Linux or any other operating system which can be accessed via SSH. This server needs to be accesible via a public IP address on the internet. You should create a hostname to point to this server and use the hostname to ssh to the server. This will allow you to connect to the server even when the IP address changes.</p>
<p>For the next step you will need to know the hostname of this server. As an example let’s say the hostname is <code class="highlighter-rouge">sshgateway.example.com</code>. We will also need to know the username you use to log into this server. We’ll use <code class="highlighter-rouge">serveruser</code> as example.</p>
<h2 id="setup-the-gateway-to-dial-ssh-on-startup">Setup the gateway to dial SSH on startup</h2>
<p>Log into your gateway using either SSH or the Wirgrid.</p>
<p>Run the following commands:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>[root@Wirnet_080E0xxx ~]# cd ~
[root@Wirnet_080E0xxx ~]# mkdir .ssh
[root@Wirnet_080E0xxx ~]# dropbearkey -t rsa -f ~/.ssh/id_rsa
</code></pre>
</div>
<p>After the last command you will see an output like this:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Generating key, this may take a while...
Public key portion is:
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCbsZlO+eEHPicyOvY5hQd9p0MclysfIC1hZ3CEyCfgQNP3RqTRtQePIWCcAGFheSjTOzJvcfhHcU9DuGALehkA0h+v4FgfPmDuq4p0JuyK12LWp/gca1eYfqNs9mMQdwunXlrEvgnS+y+ldZoBaDQUOM56PNuVnlnIsk9rNbC35DMKbtlCuxjPIVXcY9Dozen2t3YbaqG8g/Rx0PH0+EwaR0nw5i64lQJlDyCM4tVWgkfPkTQ8i1uf7Oww69zHibUPMfkWupz3Qweqc4tpBEDZ7BoZhnc5SpVZNmYLYvHOEdaoLT/GWjx0CP9MBVk9V1FIw0AjbJ2Iu0QMbhiH9mAb root@Wirnet_080E0xxx
Fingerprint: md5 25:51:e4:04:06:3b:2e:b8:be:eb:df:26:9d:d2:58:8b
</code></pre>
</div>
<p>Copy the entire line starting with <code class="highlighter-rouge">ssh-rsa</code> and ending with <code class="highlighter-rouge">root@Wirnet_080E0xxx</code>. This is called the public key. Save this to a file as a backup. We will need this later. You might also want to make a backup of the <code class="highlighter-rouge">~/.ssh/id_rsa</code> file. You can use SCP to copy the file from the gateway: <code class="highlighter-rouge">scp root@kerlink-ip-address:/root/.ssh/id_rsa .</code></p>
<p>On the gateway create a file called <code class="highlighter-rouge">startSshTunnel.sh</code> by running:</p>
<p><code class="highlighter-rouge">[root@Wirnet_080E0xxx ~]# vi startReverseSshTunnel.sh</code></p>
<p>Press <code class="highlighter-rouge">i</code> and then paste the following code.</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c"># Put "/root/startReverseSshTunnel.sh &amp;" at bottom of /etc/rc.d/rc.local</span>

<span class="k">while </span><span class="nb">true
</span><span class="k">do</span>
  <span class="c"># loop infinitely</span>
  /sbin/start-stop-daemon -x <span class="se">\</span>
  ssh -p /var/run/rev-ssh-1.pid -m -S <span class="se">\</span>
  -- -i /root/.ssh/id_rsa -K 10 -y <span class="se">\</span>
  -o <span class="nv">UseSyslog</span><span class="o">=</span>yes -o <span class="nv">ExitOnForwardFailure</span><span class="o">=</span>yes -N <span class="se">\</span>
  -R sshgateway.example.com:20022:localhost:22 <span class="se">\</span>
  serveruser@sshgateway.example.com

  sleep 1
<span class="k">done</span>
</code></pre>
</div>
<p>In two instances replace <code class="highlighter-rouge">sshgateway.example.com</code> by your hostname and replace in one instance <code class="highlighter-rouge">serveruser</code> by your server’s username.</p>
<p>Press the escape key on your keyboard, then type <code class="highlighter-rouge">:w</code>, press enter, then type <code class="highlighter-rouge">:q</code> and enter again. The file should be saved now.</p>
<p>Run the following command to allow this file to execute as a program.</p>
<p><code class="highlighter-rouge">[root@Wirnet_080E0xxx ~]# chmod +x startSshTunnel.sh</code></p>
<p>Now add this file to the end of /etc/rcd/rc.local by doing the following.</p>
<p><code class="highlighter-rouge">[root@Wirnet_080E0xxx ~]# vi /etc/rc.d/rc.local</code></p>
<p>Press <code class="highlighter-rouge">i</code> to start typing. Go down to the end and paste <code class="highlighter-rouge">/root/startReverseSshTunnel.sh &amp;</code>. Press escape, then <code class="highlighter-rouge">:w</code>, enter, <code class="highlighter-rouge">:q</code>, enter.</p>
<p><code class="highlighter-rouge">/etc/rc.d/rc.local</code> should look like this:</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c">#</span>
<span class="c"># This script will be executed *after* all the other init scripts.</span>
<span class="c"># You can put your own initialization stuff in here</span>

<span class="c"># reset rescue counter</span>
fw_setenv bootfail 0

<span class="c"># Stop watchdog if debug or prod mode</span>
<span class="nv">RUNLEVEL</span><span class="o">=</span><span class="sb">`</span>runlevel | awk <span class="s1">'{print $NF}'</span><span class="sb">`</span>
<span class="k">case</span> <span class="k">${</span><span class="nv">RUNLEVEL</span><span class="k">}</span> <span class="k">in
        </span>2|4<span class="p">)</span>
           wirma2hw wd down
           <span class="p">;;</span>
        <span class="k">*</span><span class="p">)</span>
           <span class="p">;;</span>
<span class="k">esac</span>

/root/startReverseSshTunnel.sh &amp;
</code></pre>
</div>
<h2 id="disable-the-kerlink-firewall">Disable the Kerlink firewall</h2>
<p>By default the firewall on the Kerlink blocks outgoing SSH connections. You can either add a rule to allow this, or you can disable the firewall. Edit <code class="highlighter-rouge">/etc/sysconfig/network</code> by using <code class="highlighter-rouge">vi</code> like before. Change <code class="highlighter-rouge">FIREWALL=yes</code> to <code class="highlighter-rouge">FIREWALL=no</code>.</p>
<p>Restart the network to apply the firewall change:</p>
<p><code class="highlighter-rouge">[root@Wirnet_080E0188 ~]# /etc/init.d/network restart</code></p>
<h2 id="copy-your-public-key-to-the-server">Copy your public key to the server</h2>
<p>Copy-paste the public key you saved earlier and add it to the <code class="highlighter-rouge">~/.ssh/authorized_keys</code> on the server.</p>
<p>Execute the following on the gateway</p>
<div class="highlighter-rouge"><pre class="highlight"><code>[root@Wirnet_080E0xxx ~]# ssh -i /root/.ssh/id_rsa serveruser@sshgateway.example.com
</code></pre>
</div>
<p>If you do not get a password prompt or an error, and you are logged into the server, your key exchange has been done correctly.</p>
<h2 id="reverse-ssh-into-the-gateway-from-your-server">Reverse SSH into the gateway from your server</h2>
<p>Restart the gateway and wait two minutes. Log into your server and try to SSH into the gateway via the reverse SSH tunnel:</p>
<p><code class="highlighter-rouge">ssh root@localhost -p 20022</code></p>
<p>If everything has been done correctly you should be asked for the password and then logged into the gateway.</p>
          </div>  
        </div>
        <div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="lightbox" tabindex="-1" role="dialog">
  <div class="modal-dialog text-center" role="document" style="width:auto;padding:20px;">
    <a href="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png"><img class="modal-content modal-body" src="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png" alt="Zoom" /></a>
  </div>
</div>
<script src="/docs/assets/js/page.js"></script>
    </div>
    <div id="footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ttn-components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-navbar.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-footer.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ga.js"></script>
  </body>
</html>
