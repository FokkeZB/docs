<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="stylesheet" href="/docs/assets/css/main.css" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
    (function(canonical) {
      if (!document.location.href.substr(0, document.location.href.length - document.location.hash.length).startsWith(canonical)) {
        window.location.replace(canonical);
      }
    })('https://www.thethingsnetwork.org/docs/applications/aws/thing-shadows.html');
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Thing Shadows | The Things Network</title>
<meta name="generator" content="Jekyll v3.4.5" />
<meta property="og:title" content="Thing Shadows" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Thing Shadows" />
<meta property="og:description" content="Thing Shadows" />
<link rel="canonical" href="https://www.thethingsnetwork.org/docs/applications/aws/thing-shadows.html" />
<meta property="og:url" content="https://www.thethingsnetwork.org/docs/applications/aws/thing-shadows.html" />
<meta property="og:site_name" content="The Things Network" />
<meta property="og:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-15T12:25:33+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="twitter:title" content="Thing Shadows" />
<meta name="twitter:site" content="@thethingsnetwrk" />
<meta property="article:publisher" content="https://www.facebook.com/thethingsnetwork" />
<script type="application/ld+json">
{"headline":"Thing Shadows","dateModified":"2021-03-15T12:25:33+00:00","datePublished":"2021-03-15T12:25:33+00:00","description":"Thing Shadows","url":"https://www.thethingsnetwork.org/docs/applications/aws/thing-shadows.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.thethingsnetwork.org/docs/applications/aws/thing-shadows.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ttnstaticfile.blob.core.windows.net/static/common/favicon/largetile.png"}},"image":"https://www.thethingsnetwork.org/docs/assets/images/og-image.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
    <link rel="apple-touch-icon-precomposed" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png">
    <meta name="application-name" content="The Things Network">
    <meta name="msapplication-tooltip" content="Tooltip">
    <meta name="msapplication-config" content="https://ttnweb.azureedge.net/static/common/favicon/ieconfig.54334a5ee30c.xml">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-32.61b30f85680a.png" sizes="32x32">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-57.83b86c64dc82.png" sizes="57x57">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-76.7dcf8fa36dfc.png" sizes="76x76">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-96.27ac17adaa8b.png" sizes="96x96">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-120.e1526731335e.png" sizes="120x120">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-128.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png" sizes="144x144">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png" sizes="152x152">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-180.fcd414307ca3.png" sizes="180x180">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-195.c55ce09d66da.png" sizes="195x195">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-228.bea53ec4b10b.png" sizes="228x228">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/smalltile.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/mediumtile.3d42f7faac82.png" sizes="270x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/widetile.3d42f7faac82.png" sizes="558x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/largetile.eb144ebab4d1.png" sizes="558x558">
    <link rel="shortcut icon" sizes="196x196" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-196.277278d69ddc.png">
    <script src="/docs/assets/js/main.js"></script>
  </head>
  <body>
    <div id="header"></div>
    <div id="content">
<div class="layout-page">
  <!-- <div class="ttn-header ttn-header-small">
    <div class="ttn-container container-fluid">
      <h1>
        <img src="/docs/assets/images/the-things-white.png" alt="â›… The Things Network" />
        <span>Learn</span>
      </h1>
    </div>
  </div> -->
  <div class="container-fluid ttn-container">
    <div class="row page-top-nav">
      <div class="col-sm-9">
        <ul>
          <!--<li class="page-top-nav-crumb"><a href="http://www.thethingsnetwork.org/">Home</a></li>-->
          <li class="page-top-nav-crumb"><a href="/docs/">Learn</a></li>
                <li class=""><a href="/docs/quick-start/">Quick Start</a></li>
                <li class=""><a href="/docs/lorawan/">LoRaWAN</a></li>
                <li class=""><a href="/docs/devices-and-gateways/">Devices & Gateways</a></li>
                <li class=""><a href="/docs/applications-and-integrations/">Applications</a></li>
                <li class=""><a href="/docs/the-things-stack/">The Things Stack</a></li>
                <li class=""><a href="/docs/v2-docs/">V2 docs</a></li>
        </ul>
      </div>
      <div class="hidden-xs col-sm-3 text-right">
        <a href="https://github.com/TheThingsNetwork/docs/edit/master/_content/applications/aws/thing-shadows.md" class="page-edit" data-proofer-ignore><i class="fa fa-github"></i> Edit <strong>thing-shadows.md</strong></a>
      </div>
    </div>
    <div class="row wrapper">
      <div class="col-sm-3 side-nav">
        <div class="panel page-side-nav">
          <div class="panel-body">
            <ul>
              <li class=""><a href="/docs/applications/index.html"><h5>Applications</h5></a>
            <ul>
                <li class=""><a href="/docs/applications/add.html">Add an Application</a>
                </li>
                <li class=""><a href="/docs/applications/options.html">Build an Application</a>
                </li>
            </ul>
              </li>
            <li class="page-side-nav-section"><span>APIs</span>
            <ul>
                <li class=""><a href="/docs/applications/apis.html">Overview</a>
                </li>
                <li class=""><a href="/docs/applications/manager/">Application Manager API</a>
                </li>
                <li class=""><a href="/docs/applications/mqtt/">Data API (MQTT)</a>
                </li>
            </ul>
            </li>
            <li class="page-side-nav-section"><span>SDKs & Libraries</span>
            <ul>
                <li class=""><a href="/docs/applications/sdks.html">Overview</a>
                </li>
                <li class=""><a href="/docs/applications/golang/">Go</a>
                </li>
                <li class=""><a href="/docs/applications/java/">Java</a>
                </li>
                <li class=""><a href="/docs/applications/nodered/">Node-RED</a>
                </li>
                <li class=""><a href="/docs/applications/nodejs/">Node.js</a>
                </li>
                <li class=""><a href="/docs/applications/python/">Python</a>
                </li>
            </ul>
            </li>
            <li class="page-side-nav-section"><span>Integrations</span>
            <ul>
                <li class=""><a href="/docs/applications/integrations.html">Overview</a>
                </li>
                <li class=""><a href="/docs/applications/aws/">AWS IoT</a>
            <ul>
                <li class=""><a href="/docs/applications/aws/quick-start.html">Quick Start</a>
                </li>
                <li class=""><a href="/docs/applications/aws/thing-registry.html">Thing Registry</a>
                </li>
                <li class=""><a href="/docs/applications/aws/test-messages.html">Test Messages</a>
                </li>
                <li class="active"><a href="/docs/applications/aws/thing-shadows.html">Thing Shadows</a>
                </li>
                <li class=""><a href="/docs/applications/aws/act-on-data.html">Act on Data</a>
                </li>
                <li class=""><a href="/docs/applications/aws/view-metrics.html">View Metrics</a>
                </li>
                <li class=""><a href="/docs/applications/aws/update.html">Update</a>
                </li>
                <li class=""><a href="/docs/applications/aws/troubleshooting.html">Troubleshooting</a>
                </li>
            </ul>
                </li>
                <li class=""><a href="/docs/applications/att/">AllThingsTalk</a>
                </li>
                <li class=""><a href="/docs/applications/cayenne/">Cayenne</a>
                </li>
                <li class=""><a href="/docs/applications/collos/">Collos</a>
                </li>
                <li class=""><a href="/docs/applications/http/">HTTP</a>
                </li>
                <li class=""><a href="/docs/applications/opensensors/">OpenSensors</a>
                </li>
                <li class=""><a href="/docs/applications/storage/">Storage</a>
                </li>
                <li class=""><a href="/docs/applications/ttnmapper/">TTN Mapper</a>
                </li>
                <li class=""><a href="/docs/applications/tago/">Tago</a>
                </li>
                <li class=""><a href="/docs/applications/thingspeak/">ThingSpeak</a>
                </li>
                <li class=""><a href="/docs/applications/evrythng/">EVRYTHNG</a>
                </li>
            </ul>
            </li>
            </ul>
            <!-- <li class="hidden-xs col-sm-2 page-toc page-affix"></li> --> 
          </div>
        </div> 
      </div>
      <div class="col-sm-9 page-body">
        <div class="panel">
          <div class="panel-body page-content">
            <h1 id="thing-shadows">Thing Shadows</h1>
<p>A very powerful feature of AWS IoT are <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-thing-shadows.html">Thing Shadows</a>: a JSON document that is used to store and retrieve current state information.</p>
<p>The integration supports reporting shadow state on uplink messages, and send shadow delta updates as downlink messages.</p>
<h2 id="report-shadow-state">Report Shadow State</h2>
<p>For reporting shadow state on uplink messages, you need to return the state in a <code class="highlighter-rouge">state</code> object as a result of your Decoder or Converter payload function in The Things Network. Do not put telemetry inside the <code class="highlighter-rouge">state</code> object. For example:</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Decoder</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">light</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">temperature</span> <span class="o">=</span> <span class="p">((</span><span class="nx">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"red"</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span><span class="nx">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">]];</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">light</span><span class="p">:</span> <span class="nx">light</span><span class="p">,</span>
    <span class="na">temperature</span><span class="p">:</span> <span class="nx">temperature</span><span class="p">,</span>
    <span class="na">state</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">color</span><span class="p">:</span> <span class="nx">color</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>
</div>
<p>This function returns <code class="highlighter-rouge">light</code> and <code class="highlighter-rouge">temperature</code> as <strong>telemetry</strong> and <code class="highlighter-rouge">color</code> as <strong>reported shadow state</strong>.</p>
<ol>
  <li>Log in to the <a href="http://console.aws.amazon.com">AWS Management Console</a></li>
  <li>In <strong>Services</strong> under <strong>Internet Of Things</strong>, go to <strong>AWS IoT</strong></li>
  <li>In the menu on the left under <strong>Manage</strong>, go to <strong>Things</strong></li>
  <li>Go to a thing that reports shadow state</li>
  <li>
    <p>Click <strong>Shadow</strong> to see its shadow:</p>
    <p><img src="reported-shadow.png" alt="Reported shadow" /></p>
  </li>
</ol>
<h2 id="send-shadow-delta-updates">Send Shadow Delta Updates</h2>
<p>Sending shadow delta updates as downlink messages requires you to encode a <code class="highlighter-rouge">state</code> object in your encoder payload function to bytes, for example:</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Encoder</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"red"</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bytes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">colors</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">color</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">bytes</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>This function returns the color index of the specified color in <code class="highlighter-rouge">state</code>.</p>
<ol>
  <li>Still in the AWS IoT thingâ€™s <strong>Shadow</strong>, click <strong>Edit</strong> next to <strong>Shadow Document</strong></li>
  <li>
    <p>Add a <code class="highlighter-rouge">desired</code> object:</p>
    <p><img src="desired-state.png" alt="Desired state" /></p>
  </li>
  <li>Click <strong>Save</strong>. This triggers a shadow delta update</li>
  <li>
    <p>When this happens, you will see the following in The Things Network Consoleâ€™s <strong>Data</strong> of your application:</p>
    <p><img src="shadow-delta-update.png" alt="Shadow delta update" /></p>
    <p>The integration schedules a downlink message with the shadow delta, to set the <code class="highlighter-rouge">color</code> to <code class="highlighter-rouge">blue</code> (row 3). This is sent to the device (row 2). The device changes its color and sends <code class="highlighter-rouge">blue</code> in the next message (row 1).</p>
  </li>
  <li>
    <p>The thing shadow is automatically updated in AWS IoT:</p>
    <p><img src="reported-desired-shadow.png" alt="Reported shadow" /></p>
  </li>
</ol>
<blockquote>
  <p>AWS IoT has extensive documentation on reported, desired and delta thing shadow states. In this guide, we use manual interaction. Programmatic interaction is easy and highly scalable by using the AWS IoT HTTP API and MQTT protocols. <a href="https://docs.aws.amazon.com/iot/latest/developerguide/using-thing-shadows.html">See Using Thing Shadows</a></p>
</blockquote>
          </div>  
        </div>
        <div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="lightbox" tabindex="-1" role="dialog">
  <div class="modal-dialog text-center" role="document" style="width:auto;padding:20px;">
    <a href="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png"><img class="modal-content modal-body" src="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png" alt="Zoom" /></a>
  </div>
</div>
<script src="/docs/assets/js/page.js"></script>
    </div>
    <div id="footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ttn-components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-navbar.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-footer.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ga.js"></script>
  </body>
</html>
