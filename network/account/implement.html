<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="stylesheet" href="/docs/assets/css/main.css" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
    (function(canonical) {
      if (!document.location.href.substr(0, document.location.href.length - document.location.hash.length).startsWith(canonical)) {
        window.location.replace(canonical);
      }
    })('https://www.thethingsnetwork.org/docs/network/account/implement.html');
    </script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Implementing Your Own | The Things Network</title>
<meta name="generator" content="Jekyll v3.4.5" />
<meta property="og:title" content="Implementing Your Own" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Implementing you own Account Server for application management" />
<meta property="og:description" content="Implementing you own Account Server for application management" />
<link rel="canonical" href="https://www.thethingsnetwork.org/docs/network/account/implement.html" />
<meta property="og:url" content="https://www.thethingsnetwork.org/docs/network/account/implement.html" />
<meta property="og:site_name" content="The Things Network" />
<meta property="og:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-10T16:57:22+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.thethingsnetwork.org/docs/assets/images/og-image.png" />
<meta property="twitter:title" content="Implementing Your Own" />
<meta name="twitter:site" content="@thethingsnetwrk" />
<meta property="article:publisher" content="https://www.facebook.com/thethingsnetwork" />
<script type="application/ld+json">
{"datePublished":"2021-03-10T16:57:22+00:00","image":"https://www.thethingsnetwork.org/docs/assets/images/og-image.png","description":"Implementing you own Account Server for application management","url":"https://www.thethingsnetwork.org/docs/network/account/implement.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ttnstaticfile.blob.core.windows.net/static/common/favicon/largetile.png"}},"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.thethingsnetwork.org/docs/network/account/implement.html"},"headline":"Implementing Your Own","dateModified":"2021-03-10T16:57:22+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
    <link rel="apple-touch-icon-precomposed" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png">
    <meta name="application-name" content="The Things Network">
    <meta name="msapplication-tooltip" content="Tooltip">
    <meta name="msapplication-config" content="https://ttnweb.azureedge.net/static/common/favicon/ieconfig.54334a5ee30c.xml">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-32.61b30f85680a.png" sizes="32x32">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-57.83b86c64dc82.png" sizes="57x57">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-76.7dcf8fa36dfc.png" sizes="76x76">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-96.27ac17adaa8b.png" sizes="96x96">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-120.e1526731335e.png" sizes="120x120">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-128.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-144.61bd01a950fb.png" sizes="144x144">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-152.6c70a98e264d.png" sizes="152x152">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-180.fcd414307ca3.png" sizes="180x180">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-195.c55ce09d66da.png" sizes="195x195">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-228.bea53ec4b10b.png" sizes="228x228">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/smalltile.fabea041224c.png" sizes="128x128">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/mediumtile.3d42f7faac82.png" sizes="270x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/widetile.3d42f7faac82.png" sizes="558x270">
    <link rel="icon" href="https://ttnweb.azureedge.net/static/common/favicon/largetile.eb144ebab4d1.png" sizes="558x558">
    <link rel="shortcut icon" sizes="196x196" href="https://ttnweb.azureedge.net/static/common/favicon/favicon-196.277278d69ddc.png">
    <script src="/docs/assets/js/main.js"></script>
  </head>
  <body>
    <div id="header"></div>
    <div id="content">
<div class="layout-page">
  <!-- <div class="ttn-header ttn-header-small">
    <div class="ttn-container container-fluid">
      <h1>
        <img src="/docs/assets/images/the-things-white.png" alt="â›… The Things Network" />
        <span>Learn</span>
      </h1>
    </div>
  </div> -->
  <div class="container-fluid ttn-container">
    <div class="row page-top-nav">
      <div class="col-sm-9">
        <ul>
          <li class="page-top-nav-crumb"><a href="http://www.thethingsnetwork.org/">Home</a></li>
          <li class="page-top-nav-crumb"><a href="/docs/">Learn</a></li>
                <li class=""><a href="/docs/lorawan/">LoRaWAN</a></li>
                <li class=""><a href="/docs/devices/">Devices</a></li>
                <li class=""><a href="/docs/gateways/">Gateways</a></li>
                <li class="active"><a href="/docs/network/">Network</a></li>
                <li class=""><a href="/docs/applications/">Applications</a></li>
                <li class=""><a href="/docs/the-things-stack-v3/">The Things Stack V3</a></li>
        </ul>
      </div>
      <div class="hidden-xs col-sm-3 text-right">
        <a href="https://github.com/TheThingsNetwork/docs/edit/master/_content/network/account/implement.md" class="page-edit" data-proofer-ignore><i class="fa fa-github"></i> Edit <strong>implement.md</strong></a>
      </div>
      <div class="col-12">
        This documentation page applies to the legacy Things Network Stack V2. Documentation for The Things Stack V3 is available <a href="https://thethingsstack.io">here</a>
      </div>
    </div>
    <div class="row wrapper">
      <div class="col-sm-3 side-nav">
        <div class="panel page-side-nav">
          <div class="panel-body">
            <ul>
              <li class="">
<a href="/docs/network/index.html"><h5>Network</h5></a>
            <ul>
                <li class="">
<a href="/docs/network/troubleshooting.html">Troubleshooting</a>
                </li>
                <li class="">
<a href="/docs/network/architecture.html">Network Architecture</a>
                </li>
                <li class="">
<a href="/docs/network/security.html">Network Security</a>
                </li>
            </ul>
              </li>
            <li class="page-side-nav-section">
<span>Manage</span>
            <ul>
                <li class="">
<a href="/docs/network/console/">The Things Network Console</a>
                </li>
                <li class="">
<a href="/docs/network/cli/">The Things Network CLI</a>
                </li>
            </ul>
            </li>
            <li class="page-side-nav-section">
<span>Components</span>
            <ul>
                <li class="">
<a href="/docs/network/account/">Account Server</a>
            <ul>
                <li class="">
<a href="/docs/network/account/authentication.html">Authentication</a>
                </li>
                <li class="active">
<a href="/docs/network/account/implement.html">Implementing Your Own</a>
                </li>
                <li class="">
<a href="/docs/network/account/clientid.html">Request a Client ID</a>
                </li>
                <li class="">
<a href="/docs/network/account/api.html">API Reference</a>
                </li>
            </ul>
                </li>
                <li class="">
<a href="/docs/network/discovery/">Discovery Server</a>
                </li>
            </ul>
            </li>
            </ul>
            <!-- <li class="hidden-xs col-sm-2 page-toc page-affix"></li> --> 
          </div>
        </div> 
      </div>
      <div class="col-sm-9 page-body">
        <div class="panel">
          <div class="panel-body page-content">
            <h1 id="implementing-you-own-account-server-for-application-management">Implementing you own Account Server for application management</h1>
<p>To implement your own account server, you need to implement a couple of things:</p>
<ol>
  <li>An access key validation endpoint</li>
  <li>Endpoints to generate and validate application access tokens</li>
</ol>
<h1 id="1-access-key-validation">1. Access Key validation</h1>
<p>To validate access keys, MQTT needs to know what rights the access key provides.
Since the access keys are opaque, it consults an endpoint to fetch those rights:</p>
<div class="language-plaintext highlighter-rouge">
<pre class="highlight"><code>GET /api/v2/applications/{app_id}/rights
Authorization: Key {app_access_key}
</code></pre>
</div>
<p>If the app id or access key is invalid, it should return <code class="highlighter-rouge">401</code>.</p>
<p>When successful, the enpoint should return:</p>
<div class="language-plaintext highlighter-rouge">
<pre class="highlight"><code>200 OK
Content-Type: application/json

[
  "messages:up:r",
  "messages:down:w"
]
</code></pre>
</div>
<p>The meaning of rights returned here are:</p>
<ul>
  <li>
<code class="highlighter-rouge">messages:up:r</code>:  The right to read the uplink messages from devices an application</li>
  <li>
<code class="highlighter-rouge">messages:down:w</code>: The right to send the downlink messages to devices of an application</li>
</ul>
<p>The presence of these rights tells the MQTT plugin what type of messages allow
the client to see or send.</p>
<blockquote>
  <p>Important Note: due to the limited right management of our MQTT  auhtentication implementation, make
sure to always return either both rights or none, only returning one will have
the same result as returning no rights.</p>
</blockquote>
<h1 id="2-jwt-access-token-generation">2. JWT access token generation</h1>
<p>All management features of the handler require application access tokens. These
are JWT tokens that the handler can validate without contacting the account
server.  To implement these, you need a couple of things:</p>
<ol>
  <li>A public-private key pair to sign the JWTs</li>
  <li>An endpoint where the handler can fetch the public key.</li>
  <li>JWTs that are signed using the private key, and have claims that adhere to
the correct schema.</li>
</ol>
<p>The handler fetches the public key on startup by performing the HTTP request:</p>
<div class="highlighter-rouge">
<pre class="highlight"><code>GET /key
</code></pre>
</div>
<p>which should return:</p>
<div class="highlighter-rouge">
<pre class="highlight"><code>200 OK
Content-Type: application/json

{
  "algorithm": "RS256",
  "key": "------- BEGIN PUBLIC KEY ------ ...."
}
</code></pre>
</div>
<p>The schema of the token claims should be:</p>
<div class="highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"iss"</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="err">string</span><span class="w">                  </span><span class="err">issuer</span><span class="w"> </span><span class="err">ID</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">account</span><span class="w"> </span><span class="err">server</span><span class="w">
  </span><span class="s2">"iat"</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="err">number</span><span class="w">                  </span><span class="err">seconds</span><span class="w"> </span><span class="err">since</span><span class="w"> </span><span class="err">unix</span><span class="w"> </span><span class="err">epoch</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">when</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">token</span><span class="w"> </span><span class="err">should</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">considered</span><span class="w"> </span><span class="err">valid</span><span class="w">
  </span><span class="s2">"exp"</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="err">number</span><span class="w">                  </span><span class="err">seconds</span><span class="w"> </span><span class="err">since</span><span class="w"> </span><span class="err">unix</span><span class="w"> </span><span class="err">epoch</span><span class="w"> </span><span class="err">till</span><span class="w"> </span><span class="err">when</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">token</span><span class="w"> </span><span class="err">will</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">considered</span><span class="w"> </span><span class="err">valid</span><span class="w">
  </span><span class="s2">"type"</span><span class="w">   </span><span class="err">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">                  </span><span class="err">denotes</span><span class="w"> </span><span class="err">that</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">token</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">user</span><span class="w">
  </span><span class="s2">"scope"</span><span class="w">  </span><span class="err">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">string</span><span class="w"> </span><span class="p">]</span><span class="w">              </span><span class="err">the</span><span class="w"> </span><span class="err">list</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">entities</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">token</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">valid</span><span class="w"> </span><span class="err">for</span><span class="w">
  </span><span class="s2">"apps"</span><span class="w">   </span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">string:</span><span class="w"> </span><span class="err">[</span><span class="w"> </span><span class="err">string</span><span class="w"> </span><span class="err">]</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="err">an</span><span class="w"> </span><span class="err">object</span><span class="w"> </span><span class="err">that</span><span class="w"> </span><span class="err">maps</span><span class="w"> </span><span class="err">app</span><span class="w"> </span><span class="err">id</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">respective</span><span class="w"> </span><span class="err">rights</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">token</span><span class="w"> </span><span class="err">has</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">that</span><span class="w"> </span><span class="err">app</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>So for instance, the following token:</p>
<div class="highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-account-server"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1489678139</span><span class="p">,</span><span class="w">
  </span><span class="nt">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1489688139</span><span class="p">,</span><span class="w">
  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"scope"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"apps:foo"</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nt">"apps"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"settings"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"devices"</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>gives the token the right to edit settings and manage devices for application
with id <code class="highlighter-rouge">foo</code>. The token is valid from <code class="highlighter-rouge">2017-03-16T15:28:59Z</code> until <code class="highlighter-rouge">2017-03-16T18:15:39Z</code>.</p>
<p>To validate it, the handler will consult itâ€™s configuration and look if it knows
an account server with the ID <code class="highlighter-rouge">my-account-server</code>, and validate the token with
the public key it got from its <code class="highlighter-rouge">/key</code> endpoint.</p>
<p>The available rights for an application access token are the following:</p>
<ul>
  <li>
<code class="highlighter-rouge">settings</code>: Manage application settings on the handler</li>
  <li>
<code class="highlighter-rouge">delete</code>: Unregister/delete the application on the handler</li>
  <li>
<code class="highlighter-rouge">devices</code>: View and edit devices of the application on the handler</li>
</ul>
          </div>  
        </div>
        <div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="lightbox" tabindex="-1" role="dialog">
  <div class="modal-dialog text-center" role="document" style="width:auto;padding:20px;">
    <a href="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png"><img class="modal-content modal-body" src="https://ttnstaticfile.blob.core.windows.net/static/ttn/media/logo/ttn-logo.png" alt="Zoom"></a>
  </div>
</div>
<script src="/docs/assets/js/page.js"></script>
    </div>
    <div id="footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ttn-components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-navbar.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/vue-footer.js"></script>
    <script src="https://ttnweb.azureedge.net/static/common/js/ga.js"></script>
  </body>
</html>
